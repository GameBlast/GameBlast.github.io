<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Pontuação Mensal Blast</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Estilos -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <style type="text/css">
        body {
          background: #fff;
          padding-top: 20px;
          padding-bottom: 60px;
          font-family: 'Source Sans Pro', Arial, Verdana, Tahoma, Lucida Grande, sans-serif!important;
          font-size: 15px!important;
          line-height: 26px!important;
        }
        .container {
          margin: 0 auto;
          max-width: 1000px;
        }
        .container > hr {
          margin: 60px 0;
        }
        .fakelink {
          color: #337ab7;
        }

        .fakelink:focus, .fakelink:hover {
          color: #23527c;
          text-decoration: underline;
          cursor: pointer;
        }
        #cabecalho > th {
          text-align: center;
        }
    </style>

  </head>
  <body>
    <div class="container">

      <h1>Consulta de pontuação mensal Blast</h1>
      <br/>

      <form>
        <div class="panel panel-default">
          <div class="panel-heading">Opções de pesquisa</div>
          <div class="panel-body">
            <label for="botoesBlasts">Blast</label>
        		<div class="btn-group-lg" role="group" aria-label="..." id="botoesBlasts">

              <label class="radio-inline"><input id="GB" type="radio" name='tipoBlastRadio' checked="true">GameBlast</label>
              <label class="radio-inline"><input id="NB" type="radio" name='tipoBlastRadio'>Nintendo Blast</label>
            </div>
            <label for="botoesBlasts">Mês</label>
        		<div class="form-inline" role="group" aria-label="..." id="mesAno">
              <select class="form-control sb" id="selectAno">
              </select>
              <select class="form-control sb" id="selectMes">
              </select>
            </div>
            <br/>
            <input id="botaoPesquisar" type="submit" class="btn btn-default" onClick="pesquisarIntervalo(event)" value="Pesquisar"/>

            <br/>

          </div>
        </div>
      </form>

      <br/>
      <img id="imgLoading" src="loading.gif" style="display:none"/>
      <div id="resultado" style="display:none">
        <h3>Resultado</h3>

        <br/>
        <div class="container">
          <div class="row">
            <div class='col-sm-6'>
            <label for="campoBusca">Filtrar por nome</label>
            <input type="text" class="input-sm form-control" id="campoBusca"/>
          </div>
        </div>
        <br/>
        <table class="table table-hover table-condensed">
          <tr id="cabecalho">
          </tr>
          <tr id="cabecalho-interno">
          </tr>
          <tbody id="tabela">

          </tbody>
        </table>
      </div>
    </div>

  <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js" integrity="sha256-4iQZ6BVL4qNKlQ27TExEhBN1HFPvAvAMbFavKKosSWQ=" crossorigin="anonymous"></script>
  <script type="text/javascript">//<![CDATA[

    var itens = new Array();
    var urlNoticias = '/posts/summary/-/~Not%C3%ADcia?max-results=1000&alt=json'
    var urlDestaques = '/posts/summary/-/~Destaque?max-results=1000&alt=json'
    var dataInicial = '&published-min=2017-06-25T00:00:00-03:00';
    var dataFinal = '&published-max=2017-07-25T00:00:00-03:00';
    var urlGB = 'https://www.blogger.com/feeds/4548646345780114575';
    var urlNB = 'https://www.blogger.com/feeds/5475675974957417512';
    var redatores = new Array();
    var verificaRedator = new Array();
    var meses = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];



    function getJsonFeed(strBlastId){
      //Encapsulando chamada JSON com deferred
      chamada = $.Deferred(function (def) {
        $.ajax({
          url: strBlastId,
          type: 'get',
          dataType: "jsonp",
          async: true,
          success: function(json){
            $(json.feed.entry).each(function(i, entry){
              itens.push(entry);
            });
            def.resolve(); //Resolvendo o defered, dizendo que terminou a chamada JSON
          }
        })
      }).promise();
      return chamada;
    }

    function buscaElemento(prop, valor) {
    for (var i = 0, len = redatores.length; i < len; i++)
        if (redatores[i] && redatores[i][prop] === valor) return redatores[i];
    }

    function formataDados(tipo){
      jQuery.each(itens,function(i,entry){
        var redator = {
          nome:"",
          links:[]
        };
        redator.nome = entry.author[0].name.$t;
        verificaRedator = buscaElemento("nome",redator.nome);

        var link={
          titulo:"",
          url:"",
          tipo:"",
          semana:0
        };

        link.tipo = tipo;
        link.titulo = entry.title.$t;
        jQuery.each(entry.link,function(i,url){
          if(url.rel=="alternate"){
            link.url = url.href;
            return false;
          }
        });
        link.data = entry.published.$t;

        if("undefined" === typeof verificaRedator){
          redator.links.push(link);
          redatores.push(redator);
        }
        else{
          verificaRedator.links.push(link);
        }

      });
      redatores.sort(asc_sort);
    }

    function asc_sort(a, b){
        return (b.nome.toUpperCase()) < (a.nome.toUpperCase()) ? 1 : -1;
    }



    function exibeDetalhes(id){
      var elemento = "#info"+id;
      $(elemento).toggle();
    }

    function formataData(data){
      if(data.indexOf("-03:00")>0){
        data = data.substring(0,data.indexOf("-03:00"));
      }
      else{
        data = data.substring(0,data.indexOf("-02:00"));
      }
      var d = new Date(data);
      dataFormatada = d.getDate()+"/"+(d.getMonth()+1)+"/"+d.getFullYear();
      return dataFormatada;
    }

    function converteDataParaUTC(data){
      el = data.split('/');
      if(el[0].length<2) el[0] = '0'+el[0];
      if(el[1].length<2) el[1] = '0'+(el[1]-1);
      return el[2]+'-'+el[1]+'-'+el[0]+'T00:00:00-03:00';
    }

    function recuperaDados(blast,ano,mes){
      var chamada = null
      var url = "";
      redatores = [];
      itens = [];

      if(blast=='NB'){
        url = urlNB;
      }
      else{
        url = urlGB;
      }

      url += urlNoticias;
      url += '&published-min='+converteDataParaUTC(moment().year(ano).month(mes).date('1').startOf('isoWeek').format('DD/MM/YYYY'));
      url += '&published-max='+converteDataParaUTC(moment().year(ano).month(mes).date('31').endOf('isoWeek').format('DD/MM/YYYY'));

      //Notícias
      chamada = getJsonFeed(url);

      $.when(chamada).done(function() {
        formataDados('N');
        if(blast=='NB'){
          url = urlNB;
        }
        else{
          url = urlGB;
        }
        url += urlDestaques;
        url += '&published-min='+converteDataParaUTC(moment().year(ano).month(mes).date('1').startOf('isoWeek').format('DD/MM/YYYY'));
        url += '&published-max='+converteDataParaUTC(moment().year(ano).month(mes).date('31').endOf('isoWeek').format('DD/MM/YYYY'));
        //Destaques
        chamada2 = getJsonFeed(url);
        itens=new Array();
        $.when(chamada2).done(function() {
          formataDados('D');
          montaTabela(ano,mes);
        });
      });

    }

    function montaTabela(ano,mes){
      tabela = $("#tabela");
      jQuery.each(redatores,function(i,redator){
        var links = "<tr id='info"+i+"' style='display:none !important'><td colspan='100'><table class='table table-hover table-condensed'><tr id='infoh"+i+"'><th>Data</th><th>Tipo</th><th>Título</th></tr>";
        var pontuacao = 0;
        var celulasND = "";
        var qtdNoticias = 0;
        var qtdDestaques = 0;
        var dataMes = moment().year(ano).month(mes).date('1');

        jQuery.each(redator.links,function(i,link){
          links += "<tr id='infol"+i+"'><td>"+formataData(link.data)+"</td><td>"+link.tipo+"</td><td><a href='"+link.url+"'>"+link.titulo+"</a></td></tr>";

        });
        links += "</table></td></tr>";

        do{
          qtdNoticias = 0;
          qtdDestaques = 0;
          jQuery.each(redator.links,function(i,linke){
            if(dataMes.startOf('isoWeek').date()==moment(formataData(linke.data),'DD/MM/YYYY').startOf('isoWeek').date()){
              if(linke.tipo=='N'){
                qtdNoticias++;
              }
              else{
                qtdDestaques++;
              }
            }
          });
          dataMes.add(7, 'd');
          celulasND+="<td style='border-left: 1px solid #ddd;'>"+qtdNoticias+"</td><td style='border-right: 1px solid #ddd;'>"+qtdDestaques+"</td>";
        }while(dataMes.startOf('isoWeek').month()==mes);

        tabela.append("<tr><td onClick='exibeDetalhes("+i+")' class='fakelink'>"+redator.nome+"</td>"+celulasND+"</tr>");

        tabela.append(links);
        celulasND = "";
      });
      $("#imgLoading").hide("fast");
      $("#resultado").show("fast");
      $("#botaoPesquisar").prop("disabled",false);
    }

    //Filtragem de nome
    $("#campoBusca").keyup(function () {
        var rows = $("#tabela").find("tr:not([id*=info])").hide();
        if (this.value.length) {
            var data = this.value.toUpperCase().split(" ");
            $.each(data, function (i, v) {
                rows.filter(":icontains('" + v + "'):not([id*=info])").show();
            });
        } else rows.show();
      });

    jQuery.expr[':'].icontains = function(a, i, m) {
      return jQuery(a).text().toUpperCase()
          .indexOf(m[3].toUpperCase()) >= 0;
    };

    function criaDropdowns(){
      var dropAno = $("#selectAno");
      var dropMes = $("#selectMes");

      for(i=0;i<3;i++){
        dropAno.append("<option value='"+(moment().year()-i)+"'>"+(moment().year()-i)+"</option>");
      }
      for(i=meses.length-1;i>=0;i--){
        if(moment().month()==i){
          dropMes.append("<option value='"+i+"' selected='true'>"+meses[i]+"</option>");
        }
        else{
          dropMes.append("<option value='"+i+"'>"+meses[i]+"</option>");
        }
      }
    }

    function criaCabecalho(ano,mes){
      var data = moment().year(ano).month(mes).date('1');
      var cabecalho = $('#cabecalho');
      var cabecalho2 = $('#cabecalho-interno');
      cabecalho.empty();
      cabecalho2.empty();
      cabecalho.append("<th rowspan='2' style='vertical-align: middle;'>Redator</th>");
      do{
        cabecalho.append("<th colspan='2' style='border: 1px solid #ddd;'>"+data.startOf('isoWeek').date()+"/"+(data.startOf('isoWeek').month()+1)+"</th>");
        cabecalho2.append("<th style='border: 1px solid #ddd;'>N</th><th style='border: 1px solid #ddd;'>D</th>");
        data.add(7, 'd');
      }while(data.startOf('isoWeek').month()==mes);
    }

    function pesquisarIntervalo(e){
      e.preventDefault();
      var ano = $("#selectAno").val();
      var mes = $("#selectMes").val();
      var blast = $("#botoesBlasts input:checked").attr('id');
      recuperaDados(blast,ano,mes);
      criaCabecalho(ano,mes);
      $("#imgLoading").show("fast");
      $("#resultado").hide();
      $("#tabela").empty();
      $("#botaoPesquisar").prop("disabled",true);
    }

    window.onload=function(){

      criaDropdowns();

      //recuperaDados(mes);
    }

  //]]></script>

  </body>
</html>
